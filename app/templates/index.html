{% extends "base.html" %}

{% block title %}Home - Sports Betting Dashboard{% endblock %}

{% block content %}
<!-- First-time user explainer animation -->
<div id="explainer-pointer" class="fixed left-0 right-0 top-16 z-50 hidden opacity-0 transition-all duration-500 transform -translate-y-full">
    <div class="mx-auto max-w-md bg-blue-500 text-white px-4 py-3 rounded-b-lg shadow-lg flex items-center justify-center">
        <span class="font-medium mr-2">Check out our Explainer page for detailed guide!</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </div>
</div>

<!-- Include the parlay popup template -->
{% include 'parlay_popup.html' %}

<div class="space-y-6">
    <!-- Header Section -->
    <div class="bg-white shadow-sm rounded-lg p-4">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Betting Opportunities</h1>
                <p class="text-sm text-gray-500">Last updated: 
                    {% if summary_stats.latest_timestamp %}
                        {% if summary_stats.latest_timestamp is string %}
                            {% if 'T' in summary_stats.latest_timestamp %}
                                {% set datetime_parts = summary_stats.latest_timestamp.replace('T', ' ').split('.')[0].split(' ') %}
                                {% set date_part = datetime_parts[0].split('-') %}
                                {% set time_part = datetime_parts[1].split(':') %}
                                {% set hour = time_part[0]|int %}
                                {% set minute = time_part[1] %}
                                {% set am_pm = 'AM' if hour < 12 else 'PM' %}
                                {% set display_hour = hour if hour <= 12 else hour - 12 %}
                                {% set display_hour = 12 if display_hour == 0 else display_hour %}
                                {{ date_part[1] }}/{{ date_part[2] }} {{ display_hour }}:{{ minute }} {{ am_pm }}
                            {% else %}
                                {{ summary_stats.latest_timestamp }}
                            {% endif %}
                        {% else %}
                            {{ summary_stats.latest_timestamp.strftime('%m/%d %I:%M %p') }}
                        {% endif %}
                    {% else %}
                        No data available
                    {% endif %}
                </p>
                <p class="text-sm text-gray-500 mt-1">Data is refreshed every 5 minutes to keep you in the loop with the latest betting opportunities.</p>
                <p class="text-sm text-gray-500 mt-1">This page provides a snapshot of current betting opportunities, highlighting key stats to help you make informed decisions.</p>
            </div>
            <div>
                <span class="text-3xl">🎯</span>
            </div>
        </div>
    </div>

    <!-- Quick Stats Section -->
    <div class="bg-white shadow-sm rounded-lg p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Current Opportunities -->
            <div class="bg-white p-4 rounded-lg border border-gray-200">
                <div class="flex flex-col items-center justify-center text-center">
                    <span class="text-2xl mb-1">📊</span>
                    <h3 class="text-base font-medium text-gray-500 mb-1">Current Opportunities</h3>
                    <span class="text-xl font-semibold text-gray-900">{{ summary_stats.total_bets }}</span>
                </div>
            </div>

            <!-- Grade Distribution -->
            <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h3 class="text-base font-medium text-gray-500 mb-3">Grade Distribution</h3>
                <div class="grid grid-cols-5 gap-4">
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-medium text-gray-500">A</span>
                        <span class="text-base font-semibold text-green-600">{{ summary_stats.grade_distribution.A if summary_stats.grade_distribution else 0 }}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-medium text-gray-500">B</span>
                        <span class="text-base font-semibold text-blue-600">{{ summary_stats.grade_distribution.B if summary_stats.grade_distribution else 0 }}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-medium text-gray-500">C</span>
                        <span class="text-base font-semibold text-purple-600">{{ summary_stats.grade_distribution.C if summary_stats.grade_distribution else 0 }}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-medium text-gray-500">D</span>
                        <span class="text-base font-semibold text-yellow-600">{{ summary_stats.grade_distribution.D if summary_stats.grade_distribution else 0 }}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-medium text-gray-500">F</span>
                        <span class="text-base font-semibold text-red-600">{{ summary_stats.grade_distribution.F if summary_stats.grade_distribution else 0 }}</span>
                    </div>
                </div>
            </div>

            <!-- Time to Event -->
            <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h3 class="text-base font-medium text-gray-500 mb-3">Time to Event</h3>
                <div class="grid grid-cols-4 gap-4">
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-medium text-gray-500">0-3h</span>
                        <span class="text-base font-semibold text-red-600">{{ summary_stats.time_distribution.Immediate + summary_stats.time_distribution.VeryUrgent if summary_stats.time_distribution else 0 }}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-medium text-gray-500">3-6h</span>
                        <span class="text-base font-semibold text-yellow-600">{{ summary_stats.time_distribution.Urgent if summary_stats.time_distribution else 0 }}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-medium text-gray-500">6-12h</span>
                        <span class="text-base font-semibold text-purple-600">{{ summary_stats.time_distribution.Monitor if summary_stats.time_distribution else 0 }}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-medium text-gray-500">12h+</span>
                        <span class="text-base font-semibold text-blue-600">{{ summary_stats.time_distribution.Plan if summary_stats.time_distribution else 0 }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-12 gap-6">
        <!-- Betting Opportunities -->
        <div class="col-span-12">
            <div class="bg-white shadow-sm rounded-lg divide-y divide-gray-200">
                {% for bet in current_bets %}
                <div class="p-3 opportunity-row relative">
                    <div class="bg-white rounded-lg shadow-md overflow-hidden border-l-4
                        {% if bet.grade and bet.grade.grade == 'A' %}border-green-500
                        {% elif bet.grade and bet.grade.grade == 'B' %}border-blue-500
                        {% elif bet.grade and bet.grade.grade == 'C' %}border-purple-500
                        {% elif bet.grade and bet.grade.grade == 'D' %}border-yellow-500
                        {% elif bet.grade and bet.grade.grade == 'F' %}border-red-500
                        {% else %}border-gray-400{% endif %}">
                        
                        <div class="flex flex-col already-bet-content">
                            <!-- Header with Grade -->
                            <div class="bg-gray-50 p-2 flex justify-between items-center border-b border-gray-200">
                                <div class="flex items-center gap-2">
                                    <div class="rounded-md w-8 h-8 flex items-center justify-center
                                        {% if bet.grade and bet.grade.grade == 'A' %}bg-green-100 text-green-700
                                        {% elif bet.grade and bet.grade.grade == 'B' %}bg-blue-100 text-blue-700
                                        {% elif bet.grade and bet.grade.grade == 'C' %}bg-purple-100 text-purple-700
                                        {% elif bet.grade and bet.grade.grade == 'D' %}bg-yellow-100 text-yellow-700
                                        {% elif bet.grade and bet.grade.grade == 'F' %}bg-red-100 text-red-700
                                        {% else %}bg-gray-100 text-gray-700{% endif %}">
                                        <span class="font-bold">{{ bet.grade.grade if bet.grade else '' }}</span>
                                    </div>
                                    <div class="text-sm font-medium">
                                        Score: {{ "%.1f"|format(bet.grade.composite_score) if bet.grade and bet.grade.composite_score else 'N/A' }}%
                                        {% if bet.unusual_grade %}
                                        <span class="ml-1 px-1 py-0.5 text-xs bg-yellow-100 text-yellow-800 rounded">Unusual Line</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if bet.id and bet.id != "None" and bet.id != None %}
                                <span class="text-xs font-medium px-2 py-1 rounded-full bg-gray-100 text-gray-700">
                                    {{ bet.id }}
                                </span>
                                {% endif %}
                            </div>
                            
                            <!-- Main Card Content -->
                            <div class="p-3">
                                <!-- Flex container for better space usage -->
                                <div class="flex">
                                    <!-- Left side - Bet Details -->
                                    <div class="w-1/3 pr-2">
                                        {% if bet.participant and bet.participant != "None" %}
                                        <h3 class="text-lg font-medium text-gray-900 leading-tight">{{ bet.participant }}</h3>
                                        {% endif %}
                                        
                                        <p class="text-sm font-medium text-gray-800 mt-1 leading-tight">
                                            {{ bet.bet_type or "Unknown" }}{% if bet.bet_line and bet.bet_line != "None" %} - {{ bet.bet_line }}{% endif %}
                                        </p>
                                        
                                        <div class="text-sm text-gray-700 mt-1 leading-tight">
                                            {% if bet.home_team and bet.away_team %}
                                            {{ bet.home_team }} vs {{ bet.away_team }}
                                            {% elif bet.event_teams %}
                                            {{ bet.event_teams }}
                                            {% endif %}
                                        </div>
                                        
                                        <p class="text-xs text-gray-500 mt-1">{{ bet.sport or "Unknown" }}{% if bet.league %} - {{ bet.league }}{% endif %}</p>
                                    </div>
                                    
                                    <!-- Right side - Metrics Grid -->
                                    <div class="w-2/3">
                                        <div class="grid grid-cols-4 gap-x-2 gap-y-3">
                                            <!-- Top row: Odds, Current EV, Time Left, Bet Size -->
                                            <!-- Odds -->
                                            <div>
                                                <dt class="text-xs font-medium text-gray-500">Odds</dt>
                                                <dd class="text-sm font-medium text-gray-900 flex items-center gap-1">
                                                    {{ '+' if bet.odds and bet.odds > 0 }}{{ bet.odds|int if bet.odds else 'N/A' }}
                                                    
                                                    {% if bet.initial_odds is not none and bet.odds is not none %}
                                                        {% if bet.initial_odds is string %}
                                                            {% set initial_odds_val = bet.initial_odds.replace('+', '') | int %}
                                                        {% else %}
                                                            {% set initial_odds_val = bet.initial_odds %}
                                                        {% endif %}
                                                        
                                                        {% set odds_diff = bet.odds - initial_odds_val %}
                                                        {% set crosses_zero = (bet.odds > 0 and initial_odds_val < 0) or (bet.odds < 0 and initial_odds_val > 0) %}
                                                        
                                                        {% if crosses_zero %}
                                                            {% if bet.odds > initial_odds_val %}
                                                                <span title="Odds improved: {{ initial_display }} → {{ current_display }}" class="text-green-600 font-bold">↑</span>
                                                            {% else %}
                                                                <span title="Odds worsened: {{ initial_display }} → {{ current_display }}" class="text-red-600 font-bold">↓</span>
                                                            {% endif %}
                                                        {% else %}
                                                            {% set odds_improving = bet.odds > initial_odds_val %}
                                                            {% set odds_diff_percent = ((bet.odds - initial_odds_val) / initial_odds_val * 100) | abs if initial_odds_val != 0 else 0 %}
                                                            {% set initial_display = '+' + initial_odds_val|string if initial_odds_val > 0 else initial_odds_val|string %}
                                                            {% set current_display = '+' + bet.odds|string if bet.odds > 0 else bet.odds|string %}
                                                            
                                                            {% if odds_improving and odds_diff != 0 %}
                                                                {% if odds_diff_percent > 30 %}
                                                                    <span title="Odds improved significantly: {{ initial_display }} → {{ current_display }}" class="text-green-600 font-bold">↑↑↑</span>
                                                                {% elif odds_diff_percent > 15 %}
                                                                    <span title="Odds improved strongly: {{ initial_display }} → {{ current_display }}" class="text-green-600 font-bold">↑↑</span>
                                                                {% else %}
                                                                    <span title="Odds improved: {{ initial_display }} → {{ current_display }}" class="text-green-600 font-bold">↑</span>
                                                                {% endif %}
                                                            {% elif odds_diff != 0 %}
                                                                {% if odds_diff_percent > 30 %}
                                                                    <span title="Odds worsened significantly: {{ initial_display }} → {{ current_display }}" class="text-red-600 font-bold">↓↓↓</span>
                                                                {% elif odds_diff_percent > 15 %}
                                                                    <span title="Odds worsened strongly: {{ initial_display }} → {{ current_display }}" class="text-red-600 font-bold">↓↓</span>
                                                                {% else %}
                                                                    <span title="Odds worsened: {{ initial_display }} → {{ current_display }}" class="text-red-600 font-bold">↓</span>
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endif %}
                                                </dd>
                                            </div>
                                            
                                            <!-- EV% -->
                                            <div>
                                                <dt class="text-xs font-medium text-gray-500">Current EV</dt>
                                                <dd class="flex items-center gap-1">
                                                    <span class="px-2 py-0.5 text-sm font-medium rounded
                                                        {% if bet.ev_percent and bet.ev_percent >= 10 %}bg-green-100 text-green-800
                                                        {% elif bet.ev_percent and bet.ev_percent >= 5 %}bg-lime-100 text-lime-800
                                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                        {{ "%.2f"|format(bet.ev_percent) if bet.ev_percent else 'N/A' }}%
                                                    </span>
                                                    
                                                    {% if bet.initial_ev is not none and bet.ev_percent is not none %}
                                                        {% set ev_diff = bet.ev_percent - bet.initial_ev %}
                                                        {% if ev_diff > 5 %}
                                                            <span title="EV increased significantly ({{ '%+.2f'|format(ev_diff) }}%)" class="text-green-600 font-bold">↑↑↑</span>
                                                        {% elif ev_diff > 2 %}
                                                            <span title="EV increased strongly ({{ '%+.2f'|format(ev_diff) }}%)" class="text-green-600 font-bold">↑↑</span>
                                                        {% elif ev_diff > 0.5 %}
                                                            <span title="EV increased ({{ '%+.2f'|format(ev_diff) }}%)" class="text-green-600 font-bold">↑</span>
                                                        {% elif ev_diff < -5 %}
                                                            <span title="EV decreased significantly ({{ '%+.2f'|format(ev_diff) }}%)" class="text-red-600 font-bold">↓↓↓</span>
                                                        {% elif ev_diff < -2 %}
                                                            <span title="EV decreased strongly ({{ '%+.2f'|format(ev_diff) }}%)" class="text-red-600 font-bold">↓↓</span>
                                                        {% elif ev_diff < -0.5 %}
                                                            <span title="EV decreased ({{ '%+.2f'|format(ev_diff) }}%)" class="text-red-600 font-bold">↓</span>
                                                        {% endif %}
                                                    {% endif %}
                                                </dd>
                                            </div>
                                            
                                            <!-- Time Left -->
                                            <div>
                                                <dt class="text-xs font-medium text-gray-500">Time Left</dt>
                                                <dd>
                                                    <span class="px-2 py-0.5 text-sm font-medium rounded
                                                        {% if bet.event_time and now is defined %}
                                                            {% if bet.event_time is not string %}
                                                                {% set time_diff = (bet.event_time - now).total_seconds() %}
                                                                {% if time_diff > 86400 %}bg-green-100 text-green-800
                                                                {% elif time_diff > 43200 %}bg-blue-100 text-blue-800
                                                                {% elif time_diff > 21600 %}bg-yellow-100 text-yellow-800
                                                                {% elif time_diff > 10800 %}bg-orange-100 text-orange-800
                                                                {% elif time_diff > 0 %}bg-red-100 text-red-800
                                                                {% else %}bg-gray-100 text-gray-800{% endif %}
                                                            {% else %}
                                                                bg-gray-100 text-gray-800
                                                            {% endif %}
                                                        {% else %}
                                                            bg-gray-100 text-gray-800
                                                        {% endif %}">
                                                        {% if bet.event_time and now is defined %}
                                                            {% if bet.event_time is not string %}
                                                                {% set time_diff = (bet.event_time - now).total_seconds() %}
                                                                {% if time_diff > 86400 %}
                                                                    {{ (time_diff / 86400)|int }}d
                                                                {% elif time_diff > 3600 %}
                                                                    {{ (time_diff / 3600)|int }}h
                                                                {% elif time_diff > 60 %}
                                                                    {{ (time_diff / 60)|int }}m
                                                                {% elif time_diff > 0 %}
                                                                    Soon
                                                                {% else %}
                                                                    Live
                                                                {% endif %}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </span>
                                                </dd>
                                            </div>
                                            
                                            <!-- Bet Size -->
                                            {% if bet.bet_size is not none %}
                                            <div>
                                                <dt class="text-xs font-medium text-gray-500">Bet Size</dt>
                                                <dd>
                                                    <span class="px-2 py-0.5 text-sm font-medium rounded
                                                        {% if bet.bet_size > 100 %}bg-green-100 text-green-800
                                                        {% elif bet.bet_size > 50 %}bg-blue-100 text-blue-800
                                                        {% elif bet.bet_size > 0 %}bg-yellow-100 text-yellow-800
                                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                        ${{ "%.0f"|format(bet.bet_size) }}
                                                    </span>
                                                </dd>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Bottom row: Sportsbook, Win Probability, Market Probability, Parlay Button -->
                                            <!-- Sportsbook -->
                                            <div>
                                                <dt class="text-xs font-medium text-gray-500">Sportsbook</dt>
                                                <dd class="text-sm font-medium text-gray-900">{{ bet.sportsbook or "Unknown" }}</dd>
                                            </div>
                                            
                                            <!-- Win Probability -->
                                            <div>
                                                <dt class="text-xs font-medium text-gray-500">Win Probability</dt>
                                                <dd class="text-sm font-medium text-gray-900">{{ "%.1f"|format(bet.win_probability) if bet.win_probability else 'N/A' }}%</dd>
                                            </div>
                                            
                                            <!-- Market Probability -->
                                            <div>
                                                <dt class="text-xs font-medium text-gray-500">Market Probability</dt>
                                                <dd class="text-sm font-medium text-gray-900">{{ "%.1f"|format(bet.market_implied_prob) if bet.market_implied_prob else 'N/A' }}%</dd>
                                            </div>
                                            
                                            <!-- Parlay Button -->
                                            {% if bet.grade and bet.grade.grade not in ['D', 'F'] and sportsbook_counts.get(bet.sportsbook, 0) > 1 %}
                                            <div>
                                                <dd class="mt-1">
                                                    <button 
                                                        onclick="loadParlayBets('{{ bet.sportsbook }}')"
                                                        class="inline-flex items-center px-2 py-1.5 text-xs font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 shadow-sm transition-colors"
                                                        title="View other high-quality bets from {{ bet.sportsbook }} that could be parlayed with this bet"
                                                    >
                                                        <span class="mr-1">🎲</span> Parlay Options
                                                        <span class="ml-1 text-xs bg-indigo-500 text-white px-1.5 py-0.5 rounded-full">
                                                            {{ sportsbook_counts.get(bet.sportsbook, 0) - 1 }}
                                                        </span>
                                                    </button>
                                                </dd>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Initial Details Section - More compact -->
                                {% if bet.initial_odds or bet.initial_ev is not none or bet.first_seen %}
                                <div class="bg-gray-50 p-2 mt-2 rounded border border-gray-200 text-xs">
                                    <div class="grid grid-cols-3 gap-2">
                                        {% if bet.first_seen %}
                                        <div class="text-gray-600 flex items-center">
                                            <span class="text-gray-500 mr-1">⏱️</span> 
                                            <span>{{ 'First seen: ' }}
                                            {% if bet.first_seen is string %}
                                                {% if 'T' in bet.first_seen %}
                                                    {% set datetime_parts = bet.first_seen.replace('T', ' ').split('.')[0].split(' ') %}
                                                    {% set date_part = datetime_parts[0].split('-') %}
                                                    {% set time_part = datetime_parts[1].split(':') %}
                                                    {% set hour = time_part[0]|int %}
                                                    {% set minute = time_part[1] %}
                                                    {% set am_pm = 'AM' if hour < 12 else 'PM' %}
                                                    {% set display_hour = hour if hour <= 12 else hour - 12 %}
                                                    {% set display_hour = 12 if display_hour == 0 else display_hour %}
                                                    {{ date_part[1] }}/{{ date_part[2] }} {{ display_hour }}:{{ minute }} {{ am_pm }}
                                                {% else %}
                                                    {{ bet.first_seen }}
                                                {% endif %}
                                            {% else %}
                                                {{ bet.first_seen.strftime('%m/%d %I:%M %p') }}
                                            {% endif %}
                                            </span>
                                        </div>
                                        {% endif %}
                                        
                                        {% if bet.initial_odds %}
                                        <div class="text-gray-600 flex items-center">
                                            <span class="text-gray-500 mr-1">🔢</span>
                                            <span>{{ 'Initial odds: ' }}{% if bet.initial_odds is string %}
                                                {% if bet.initial_odds.startswith('-') %}
                                                    {{ bet.initial_odds.split('.')[0] }}
                                                {% else %}
                                                    +{{ bet.initial_odds.lstrip('+').split('.')[0] }}
                                                {% endif %}
                                              {% else %}
                                                {% if bet.initial_odds > 0 %}+{% endif %}{{ bet.initial_odds|int }}
                                              {% endif %}</span>
                                        </div>
                                        {% endif %}
                                        
                                        {% if bet.initial_ev is not none %}
                                        <div class="text-gray-600 flex items-center">
                                            <span class="text-gray-500 mr-1">📈</span>
                                            <span>{{ 'Initial EV: ' }}{{ "%.2f"|format(bet.initial_ev) }}%</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="p-6 text-center">
                    <p class="text-gray-500">No betting opportunities available at the moment. Check back later!</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check if this is the first visit
        if (!localStorage.getItem('hasVisitedBefore')) {
            // Show explainer pointer with animation
            const explainerPointer = document.getElementById('explainer-pointer');
            explainerPointer.classList.remove('hidden');
            
            // Trigger the slide-in animation after a short delay
            setTimeout(function() {
                explainerPointer.classList.remove('opacity-0', '-translate-y-full');
            }, 300);
            
            // Hide after 3 seconds
            setTimeout(function() {
                explainerPointer.classList.add('opacity-0');
                setTimeout(function() {
                    explainerPointer.classList.add('hidden');
                }, 500);
            }, 3000);
            
            // Set flag in localStorage
            localStorage.setItem('hasVisitedBefore', 'true');
        }
    });
    
    function loadParlayBets(sportsbook) {
        fetch(`/api/sportsbook/${sportsbook}`)
            .then(response => response.json())
            .then(data => {
                // Populate the parlay popup with the data
                const parlayBetsContainer = document.getElementById('parlay-bets-container');
                parlayBetsContainer.innerHTML = '';
                
                // Sort bets by grade (A, B, C)
                const bets = data.bets;
                bets.sort((a, b) => {
                    const gradeOrder = { 'A': 0, 'B': 1, 'C': 2 };
                    return (gradeOrder[a.grade] || 3) - (gradeOrder[b.grade] || 3);
                });
                
                bets.forEach(bet => {
                    // Skip bets with grade D or F
                    if (bet.grade === 'D' || bet.grade === 'F') return;
                    
                    const betElement = document.createElement('div');
                    betElement.className = 'p-4 border-b border-gray-200 flex items-center';
                    
                    // Determine the event teams display
                    let eventDisplay = '';
                    if (bet.home_team && bet.away_team) {
                        eventDisplay = `${bet.home_team} vs ${bet.away_team}`;
                    } else if (bet.event_teams) {
                        eventDisplay = bet.event_teams;
                    } else if (bet.participant) {
                        eventDisplay = bet.participant;
                    } else {
                        eventDisplay = 'Unknown Event';
                    }
                    
                    // Format odds display
                    let oddsDisplay = 'N/A';
                    if (bet.odds !== null && bet.odds !== undefined) {
                        oddsDisplay = bet.odds > 0 ? '+' + bet.odds : bet.odds;
                    }
                    
                    // Format bet type and line
                    let betTypeDisplay = bet.bet_type || 'Unknown';
                    if (bet.bet_line && bet.bet_line !== 'None') {
                        betTypeDisplay += ` - ${bet.bet_line}`;
                    }
                    
                    // Calculate time to event
                    let timeToEvent = 'N/A';
                    let timeClass = 'text-gray-500';
                    if (bet.event_time) {
                        try {
                            // If it's a string, check for year indicators
                            if (typeof bet.event_time === 'string') {
                                if (bet.event_time.includes('2025')) {
                                    timeToEvent = '366 days';
                                    timeClass = 'text-green-600';
                                } else if (bet.event_time.includes('2024')) {
                                    timeToEvent = '1 days';
                                    timeClass = 'text-green-600';
                                } else {
                                    timeToEvent = 'Soon';
                                    timeClass = 'text-gray-500';
                                }
                            } else {
                                // Parse the event time if it's not already a Date object
                                let eventTime;
                                if (typeof bet.event_time === 'object' && bet.event_time.hasOwnProperty('seconds')) {
                                    // Handle Firestore timestamp objects
                                    eventTime = new Date(bet.event_time.seconds * 1000);
                                } else {
                                    eventTime = new Date(bet.event_time);
                                }
                                
                                const now = new Date();
                                
                                // Ensure both dates are valid before comparison
                                if (!isNaN(eventTime.getTime()) && !isNaN(now.getTime())) {
                                    const timeDiff = (eventTime - now) / 1000; // in seconds
                                    
                                    if (timeDiff > 86400) {
                                        timeToEvent = Math.floor(timeDiff / 86400) + ' days';
                                        timeClass = 'text-green-600';
                                    } else if (timeDiff > 43200) { // 12+ hours
                                        timeToEvent = Math.floor(timeDiff / 3600) + ' hours';
                                        timeClass = 'text-green-600';
                                    } else if (timeDiff > 21600) { // 6-12 hours
                                        timeToEvent = Math.floor(timeDiff / 3600) + ' hours';
                                        timeClass = 'text-yellow-600';
                                    } else if (timeDiff > 3600) { // 1-6 hours
                                        timeToEvent = Math.floor(timeDiff / 3600) + ' hours';
                                        timeClass = 'text-red-600';
                                    } else if (timeDiff > 60) {
                                        timeToEvent = Math.floor(timeDiff / 60) + ' minutes';
                                        timeClass = 'text-red-600';
                                    } else if (timeDiff > 0) {
                                        timeToEvent = 'Soon';
                                        timeClass = 'text-red-600';
                                    } else {
                                        timeToEvent = 'Live';
                                        timeClass = 'text-gray-500';
                                    }
                                } else {
                                    timeToEvent = 'Soon';
                                    timeClass = 'text-gray-500';
                                }
                            }
                        } catch (e) {
                            console.error('Error calculating time to event:', e);
                            timeToEvent = 'Soon';
                            timeClass = 'text-gray-500';
                        }
                    }
                    
                    betElement.innerHTML = `
                        <input type="checkbox" class="parlay-bet-checkbox mr-4" data-bet-id="${bet.bet_id}" 
                               data-odds="${bet.odds}" data-win-prob="${bet.win_probability}" data-ev="${bet.ev_percent}">
                        <div class="flex-1">
                            <div class="flex items-center">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                    ${bet.grade === 'A' ? 'bg-green-100 text-green-800' : 
                                      bet.grade === 'B' ? 'bg-blue-100 text-blue-800' : 
                                      'bg-purple-100 text-purple-800'}">
                                    Grade ${bet.grade || 'N/A'}
                                </span>
                                <span class="ml-2 text-xs text-gray-500">EV: ${bet.ev_percent || 'N/A'}%</span>
                                <span class="ml-2 text-xs ${timeClass}">Time: ${timeToEvent}</span>
                            </div>
                            ${bet.participant && bet.participant !== "None" ? 
                              `<p class="text-sm font-medium text-gray-900 mt-1">${bet.participant}</p>` : ''}
                            <p class="text-sm font-medium text-gray-800 mt-1">${betTypeDisplay}</p>
                            <p class="text-sm font-medium ${bet.participant ? 'text-gray-700' : 'text-gray-900'} mt-1">${eventDisplay}</p>
                            <p class="text-sm text-gray-500">${bet.sport || 'Unknown'}${bet.league ? ` - ${bet.league}` : ''}</p>
                            <p class="text-xs text-gray-500">${oddsDisplay}</p>
                        </div>
                    `;
                    parlayBetsContainer.appendChild(betElement);
                });
                
                // Show the popup
                document.getElementById('parlay-popup').classList.remove('hidden');
                
                // Reset the parlay calculation
                document.getElementById('parlay-results').classList.add('hidden');
                document.getElementById('calculate-parlay-btn').disabled = false;
            })
            .catch(error => {
                console.error('Error loading parlay bets:', error);
                alert('Error loading parlay options. Please try again.');
            });
    }
    
    function calculateParlay() {
        const selectedBets = document.querySelectorAll('.parlay-bet-checkbox:checked');
        
        if (selectedBets.length < 2) {
            alert('Please select at least 2 bets for a parlay.');
            return;
        }
        
        const betIds = Array.from(selectedBets).map(checkbox => checkbox.dataset.betId);
        
        // Disable the calculate button to prevent multiple submissions
        document.getElementById('calculate-parlay-btn').disabled = true;
        
        // Show loading state
        document.getElementById('parlay-loading').classList.remove('hidden');
        document.getElementById('parlay-results').classList.add('hidden');
        
        fetch('/api/calculate_parlay', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ bet_ids: betIds }),
        })
        .then(response => response.json())
        .then(data => {
            // Hide loading state
            document.getElementById('parlay-loading').classList.add('hidden');
            
            // Populate results
            document.getElementById('parlay-american-odds').textContent = data.american_odds > 0 ? '+' + data.american_odds.toFixed(0) : data.american_odds.toFixed(0);
            document.getElementById('parlay-decimal-odds').textContent = data.decimal_odds.toFixed(2);
            document.getElementById('parlay-implied-prob').textContent = (data.implied_probability * 100).toFixed(2) + '%';
            document.getElementById('parlay-true-prob').textContent = (data.true_probability * 100).toFixed(2) + '%';
            document.getElementById('parlay-ev').textContent = data.ev_percent.toFixed(2) + '%';
            document.getElementById('parlay-kelly').textContent = (data.kelly_fraction * 100).toFixed(2) + '%';
            document.getElementById('parlay-edge').textContent = (data.total_edge * 100).toFixed(2) + '%';
            
            // Show correlation warning if applicable
            const correlationWarning = document.getElementById('correlation-warning');
            if (data.correlated_warning) {
                correlationWarning.classList.remove('hidden');
            } else {
                correlationWarning.classList.add('hidden');
            }
            
            // Show results
            document.getElementById('parlay-results').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error calculating parlay:', error);
            alert('Error calculating parlay. Please try again.');
            document.getElementById('parlay-loading').classList.add('hidden');
            document.getElementById('calculate-parlay-btn').disabled = false;
        });
    }
    
    function closeParlay() {
        document.getElementById('parlay-popup').classList.add('hidden');
    }
</script>

<style>
.already-bet-content {
    transition: opacity 0.2s ease-in-out;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check if this is the first visit
        if (!localStorage.getItem('hasVisitedBefore')) {
            // Show explainer pointer with animation
            const explainerPointer = document.getElementById('explainer-pointer');
            explainerPointer.classList.remove('hidden');
            
            // Trigger the slide-in animation after a short delay
            setTimeout(function() {
                explainerPointer.classList.remove('opacity-0', '-translate-y-full');
            }, 300);
            
            // Hide after 3 seconds
            setTimeout(function() {
                explainerPointer.classList.add('opacity-0');
                setTimeout(function() {
                    explainerPointer.classList.add('hidden');
                }, 500);
            }, 3000);
            
            // Set flag in localStorage
            localStorage.setItem('hasVisitedBefore', 'true');
        }
    });
    
    // Other existing scripts
</script>
{% endblock %}
