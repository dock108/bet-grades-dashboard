<!-- Parlay Analysis Popup -->
<div id="parlayPopup" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="text-2xl font-bold text-gray-900">Parlay Builder</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Loading State -->
            <div id="loadingState" class="hidden">
                <div class="flex items-center justify-center p-6">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                    <span class="ml-2 text-gray-600">Loading bets...</span>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden">
                <div class="text-red-600 bg-red-50 p-4 rounded-lg border border-red-200 mb-4">
                    <p class="flex items-center">
                        <span class="mr-2">⚠️</span>
                        <span id="errorMessage">Error loading bets. Please try again.</span>
                    </p>
                    <button onclick="retryLoadBets()" class="mt-2 text-sm text-red-700 hover:text-red-800 underline">
                        Retry
                    </button>
                </div>
            </div>
            
            <!-- Sportsbook Display -->
            <div id="sportsbook-display" class="mb-4 text-lg font-semibold text-gray-800">
                <span id="sportsbook-name"></span> Parlay Options
            </div>
            
            <div class="bet-list">
                <div class="flex items-center justify-between cursor-pointer" id="availableBetsHeader" onclick="toggleAvailableBets()">
                    <h3 class="text-lg font-medium">Available Bets</h3>
                    <span id="availableBetsToggle" class="text-gray-500">▼</span>
                </div>
                <div id="availableBets" class="mt-2">
                    <!-- Bets will be populated here -->
                </div>
            </div>
            
            <div class="parlay-results" style="display: none;">
                <h3>Parlay Analysis Results</h3>
                
                <!-- Grade Display -->
                <div class="flex items-center gap-3 mb-4">
                    <div class="rounded-full w-16 h-16 flex flex-col items-center justify-center" id="parlayGradeCircle">
                        <div id="parlayGrade" class="text-lg font-semibold text-gray-600"></div>
                        <div class="text-xs text-gray-500">Grade</div>
                    </div>
                    <div class="text-sm text-gray-600">
                        <div>EV: <span id="gradeEv" class="font-medium"></span></div>
                        <div>Edge: <span id="gradeEdge" class="font-medium"></span></div>
                        <div>Win Prob: <span id="gradeWinProb" class="font-medium"></span></div>
                    </div>
                </div>
                
                <!-- Parlay Legs -->
                <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h4 class="font-semibold mb-2 text-gray-800">Parlay Legs</h4>
                    <div id="parlayLegs" class="space-y-2">
                        <!-- Legs will be populated here -->
                    </div>
                </div>
                
                <!-- Odds Comparison -->
                <div id="parlayValueAnalysis" class="mb-4 p-4 bg-green-50 rounded-lg border border-green-200" style="display: none;">
                    <h4 class="font-semibold mb-2 text-green-800">Parlay Value Analysis</h4>
                    <!-- Recommended Bet Size -->
                    <div class="mb-4">
                        <label class="text-sm text-green-700">Recommended Bet</label>
                        <div id="parlayBetSize" class="text-xl font-bold text-green-700"></div>
                    </div>
                    <!-- Odds -->
                    <div class="grid grid-cols-2 gap-4 bg-green-100 p-3 rounded-lg mb-4">
                        <div>
                            <label class="text-sm text-green-700 group relative cursor-help">
                                Calculated True Odds
                                <span class="tooltip invisible group-hover:visible absolute left-0 top-6 w-48 p-2 bg-gray-900 text-white text-xs rounded shadow-lg z-10">
                                    Our calculated fair odds based on win probabilities and potential correlations between legs
                                </span>
                            </label>
                            <div id="parlayOdds" class="text-lg font-bold text-green-700"></div>
                        </div>
                        <div>
                            <label class="text-sm text-green-700 group relative cursor-help">
                                Estimated Market Odds
                                <span class="tooltip invisible group-hover:visible absolute left-0 top-6 w-48 p-2 bg-gray-900 text-white text-xs rounded shadow-lg z-10">
                                    Expected sportsbook odds based on current market prices and standard parlay pricing
                                </span>
                            </label>
                            <div id="theoreticalOdds" class="text-lg font-bold text-green-700"></div>
                        </div>
                    </div>
                    <!-- Returns -->
                    <div class="grid grid-cols-2 gap-4 bg-green-100 p-3 rounded-lg">
                        <div>
                            <label class="text-sm text-green-700 group relative cursor-help">
                                Return at True Odds
                                <span class="tooltip invisible group-hover:visible absolute left-0 top-6 w-48 p-2 bg-gray-900 text-white text-xs rounded shadow-lg z-10">
                                    Potential payout based on our calculated true probabilities and recommended bet size
                                </span>
                            </label>
                            <div id="trueOddsPayout" class="text-lg font-bold text-green-700"></div>
                        </div>
                        <div>
                            <label class="text-sm text-green-700 group relative cursor-help">
                                Return at Market Odds
                                <span class="tooltip invisible group-hover:visible absolute left-0 top-6 w-48 p-2 bg-gray-900 text-white text-xs rounded shadow-lg z-10">
                                    Expected payout at typical market odds - look for sportsbooks offering this or better
                                </span>
                            </label>
                            <div id="marketOddsPayout" class="text-lg font-bold text-green-700"></div>
                        </div>
                    </div>
                    <div class="mt-3 text-sm text-green-800 bg-green-100 p-2 rounded">
                        ⭐ Place this parlay when your sportsbook offers odds equal to or better than our Calculated True Odds to maximize value
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="flex flex-col items-center space-y-4">
                <button id="calculateParlay" class="btn btn-primary" disabled>Calculate Parlay</button>
                <div class="p-3 bg-amber-50 rounded-lg border border-amber-200 text-center w-full">
                    <div class="text-sm text-amber-700">
                        <p>⚠️ Not all parlays may be available. Odds accuracy may be affected by <a href="https://en.wikipedia.org/wiki/Correlation" target="_blank" class="underline hover:text-amber-800">correlation</a> between bets.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 90%;
    max-width: 800px;
    border-radius: 8px;
    max-height: 90vh;
    overflow-y: auto;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: black;
}

.bet-list {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
}

.bet-item {
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    margin: 4px 0;
    background-color: white;
    transition: background-color 0.2s;
}

.bet-item:hover {
    background-color: #f9fafb;
}

.bet-item.selected {
    background-color: #f0f7ff;
    border-color: #93c5fd;
}

.bet-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.bet-item-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1a202c;
}

.bet-item-grade {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 0.875rem;
}

.bet-item-grade-A { background-color: #dcfce7; color: #166534; }
.bet-item-grade-B { background-color: #dbeafe; color: #1e40af; }
.bet-item-grade-C { background-color: #f3e8ff; color: #6b21a8; }

.bet-item-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-top: 8px;
}

.bet-item-detail {
    display: flex;
    flex-direction: column;
}

.bet-item-detail-label {
    font-size: 0.75rem;
    color: #64748b;
    margin-bottom: 2px;
}

.bet-item-detail-value {
    font-size: 0.875rem;
    color: #1a202c;
    font-weight: 500;
}

.bet-item-meta {
    display: flex;
    gap: 16px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #e2e8f0;
}

.bet-item-meta-item {
    display: flex;
    align-items: center;
    font-size: 0.875rem;
    color: #64748b;
}

.bet-item-meta-item svg {
    width: 16px;
    height: 16px;
    margin-right: 4px;
}

.result-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.result-item {
    background-color: white;
    padding: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.result-item label {
    display: block;
    font-weight: 500;
    color: #4a5568;
    margin-bottom: 0.5rem;
}

.result-item span {
    font-size: 1.125rem;
    color: #2d3748;
}

.warning {
    background-color: #fff3cd;
    color: #856404;
    padding: 12px;
    border-radius: 6px;
    margin-top: 15px;
    border: 1px solid #ffeeba;
}

.btn {
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}

.btn-primary {
    background-color: #4285f4;
    color: white;
    border: none;
}

.btn-primary:hover:not(:disabled) {
    background-color: #3367d6;
}

.btn-primary:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.modal-footer {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    text-align: right;
}

.beta-warning {
    margin-bottom: 1rem;
}

.hidden {
    display: none;
}

.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

.metric-better {
    color: #047857;  /* green-700 */
}

.metric-worse {
    color: #dc2626;  /* red-600 */
}

#availableBetsHeader {
    padding: 0.5rem;
    border-radius: 0.375rem;
    transition: background-color 0.2s;
}

#availableBetsHeader:hover {
    background-color: #f3f4f6;
}

#sportsbook-display {
    padding: 0.5rem;
    border-bottom: 2px solid #e5e7eb;
    margin-bottom: 1rem;
}

.tooltip {
    pointer-events: none;
}

.group:hover .tooltip {
    display: block;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const popup = document.getElementById('parlayPopup');
    const closeBtn = popup.querySelector('.close');
    const betsList = document.getElementById('availableBets');
    const parlayResults = document.querySelector('.parlay-results');
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const errorMessage = document.getElementById('errorMessage');
    const calculateBtn = document.getElementById('calculateParlay');
    
    let selectedBets = new Set();
    let currentSportsbook = null;

    // Initialize calculate button click handler
    if (calculateBtn) {
        calculateBtn.onclick = async function() {
            try {
                console.log('Starting parlay calculation...');
                
                // Show loading state
                loadingState.classList.remove('hidden');
                parlayResults.style.display = 'none';
                errorState.classList.add('hidden');
                
                // Safely collapse available bets section
                document.getElementById('availableBets').style.display = 'none';
                document.getElementById('availableBetsToggle').textContent = '▶';
                
                console.log('Making API call...');
                const response = await fetch('/api/calculate_parlay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        bet_ids: Array.from(selectedBets)
                    })
                });
                
                loadingState.classList.add('hidden');
                
                const result = await response.json();
                console.log('API Response:', result);
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Helper function to safely format numbers
                const formatNumber = (value, decimals = 2) => {
                    if (value === undefined || value === null || isNaN(value)) return '0.00';
                    return Number(value).toFixed(decimals);
                };
                
                // Update grade display
                const parlayGrade = document.getElementById('parlayGrade');
                const gradeEv = document.getElementById('gradeEv');
                const gradeEdge = document.getElementById('gradeEdge');
                const gradeWinProb = document.getElementById('gradeWinProb');
                
                // Calculate composite grade based on individual leg grades
                const calculateCompositeGrade = (result, selectedBets) => {
                    // Convert grades to numerical scores
                    const gradeScores = {
                        'A': 4,
                        'B': 3,
                        'C': 2,
                        'D': 1,
                        'F': 0
                    };
                    
                    // Get grades from selected bets
                    const selectedBetsArray = Array.from(document.querySelectorAll('.bet-item.selected'));
                    const grades = selectedBetsArray.map(div => {
                        const gradeEl = div.querySelector('.rounded-full');
                        return gradeEl ? gradeEl.textContent.replace('Grade ', '') : 'C';
                    });
                    
                    // Calculate average grade score
                    const totalScore = grades.reduce((sum, grade) => sum + (gradeScores[grade] || 2), 0);
                    const avgScore = totalScore / grades.length;
                    
                    // Apply diminishing returns based on number of legs
                    const legPenalty = Math.pow(0.95, grades.length - 1); // 5% penalty per additional leg
                    const adjustedScore = avgScore * legPenalty;
                    
                    // Consider EV in the grade
                    const evBonus = (result.ev_percent || result.ev || 0) / 5; // Each 5% of EV adds up to 1 point
                    const finalScore = adjustedScore + evBonus;
                    
                    // Convert back to letter grade
                    if (finalScore >= 3.5) return 'A';
                    if (finalScore >= 2.7) return 'B';
                    if (finalScore >= 2.0) return 'C';
                    if (finalScore >= 1.0) return 'D';
                    return 'F';
                };
                
                // Calculate and set the composite grade
                const compositeGrade = calculateCompositeGrade(result);
                if (parlayGrade) parlayGrade.textContent = compositeGrade;
                
                // Update other grade-related displays
                if (gradeEv) gradeEv.textContent = `${formatNumber(result.ev_percent || result.ev || 0)}%`;
                if (gradeEdge) gradeEdge.textContent = `${formatNumber(result.total_edge || 0)}%`;
                if (gradeWinProb) gradeWinProb.textContent = `${formatNumber((result.true_probability || result.true_win_prob || 0) * 100)}%`;
                
                // Update the grade circle color based on composite grade
                const parlayGradeCircle = document.getElementById('parlayGradeCircle');
                if (parlayGradeCircle) {
                    const gradeColors = {
                        'A': 'bg-green-100 text-green-800',
                        'B': 'bg-blue-100 text-blue-800',
                        'C': 'bg-purple-100 text-purple-800',
                        'D': 'bg-orange-100 text-orange-800',
                        'F': 'bg-red-100 text-red-800'
                    };
                    
                    // Remove existing color classes
                    parlayGradeCircle.className = parlayGradeCircle.className
                        .split(' ')
                        .filter(c => !c.startsWith('bg-') && !c.startsWith('text-'))
                        .join(' ');
                    
                    // Add new color classes
                    parlayGradeCircle.classList.add(...(gradeColors[compositeGrade] || 'bg-gray-100 text-gray-800').split(' '));
                }
                
                // Update odds displays
                const parlayOdds = document.getElementById('parlayOdds');
                if (parlayOdds) {
                    // American odds are provided directly from the API
                    const americanOdds = result.american_odds;
                    parlayOdds.textContent = americanOdds > 0 ? `+${americanOdds}` : americanOdds.toString();
                }
                
                // Update market odds - convert decimal to American format for consistency
                const theoreticalOdds = document.getElementById('theoreticalOdds');
                if (theoreticalOdds) {
                    // Apply a standard vig (5-10%) to the true odds
                    const vigFactor = 1.07; // 7% vig
                    const marketDecimalOdds = result.decimal_odds / vigFactor;
                    window.marketDecimalOdds = marketDecimalOdds; // Store for payout calculations
                    
                    // Convert to American format
                    let marketAmericanOdds;
                    if (marketDecimalOdds >= 2) {
                        marketAmericanOdds = Math.round((marketDecimalOdds - 1) * 100);
                    } else {
                        marketAmericanOdds = Math.round(-100 / (marketDecimalOdds - 1));
                    }
                    
                    theoreticalOdds.textContent = marketAmericanOdds > 0 ? 
                        `+${marketAmericanOdds}` : marketAmericanOdds.toString();
                }
                
                // Calculate recommended bet size
                const parlayBetSize = document.getElementById('parlayBetSize');
                if (parlayBetSize) {
                    // Get the selected bets from the UI
                    const selectedBetsArray = Array.from(document.querySelectorAll('.bet-item.selected')).map(div => {
                        const evText = div.querySelector('[title="Expected Value"]').textContent;
                        const ev = parseFloat(evText.split(': ')[1]);
                        return { ev: ev || 0 };
                    });
                    
                    // Calculate total EV and average
                    const totalEv = selectedBetsArray.reduce((sum, bet) => sum + Math.max(0, bet.ev), 0);
                    const avgEv = totalEv / selectedBetsArray.length;
                    const betCount = selectedBetsArray.length;
                    
                    // Scale bet size based on EV and number of legs
                    const scaledBetSize = avgEv * Math.pow(0.8, betCount - 1);
                    const betSizeInDollars = Math.round(scaledBetSize);
                    parlayBetSize.textContent = `$${formatNumber(betSizeInDollars)}`;
                    
                    // Calculate payouts based on recommended bet size
                    const truePayout = betSizeInDollars * result.decimal_odds;
                    const marketPayout = betSizeInDollars * marketDecimalOdds;
                    
                    // Update payout displays
                    const trueOddsPayoutEl = document.getElementById('trueOddsPayout');
                    const marketOddsPayoutEl = document.getElementById('marketOddsPayout');
                    
                    if (trueOddsPayoutEl) trueOddsPayoutEl.textContent = `$${formatNumber(truePayout)}`;
                    if (marketOddsPayoutEl) marketOddsPayoutEl.textContent = `$${formatNumber(marketPayout)}`;
                }
                
                // Show correlation warning if applicable
                const correlationWarning = document.getElementById('correlationWarning');
                if (correlationWarning) {
                    if (result.correlated_warning) {
                        correlationWarning.classList.remove('hidden');
                    } else {
                        correlationWarning.classList.add('hidden');
                    }
                }
                
                // Show results
                parlayResults.style.display = 'block';
                document.getElementById('parlayValueAnalysis').style.display = 'block';
                
            } catch (error) {
                console.error('Error calculating parlay:', error);
                errorState.classList.remove('hidden');
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = error.message || 'Error calculating parlay. Please try again.';
                }
                calculateBtn.disabled = false;
            }
        };
    }
    
    // Close popup
    closeBtn.onclick = function() {
        popup.style.display = 'none';
        parlayResults.style.display = 'none';
        errorState.classList.add('hidden');
        // Reset all values
        document.getElementById('parlayValueAnalysis').style.display = 'none';
        document.getElementById('parlayGrade').textContent = '';
        document.getElementById('gradeEv').textContent = '';
        document.getElementById('gradeEdge').textContent = '';
        document.getElementById('gradeWinProb').textContent = '';
        document.getElementById('parlayOdds').textContent = '';
        document.getElementById('theoreticalOdds').textContent = '';
        document.getElementById('parlayBetSize').textContent = '';
        document.getElementById('trueOddsPayout').textContent = '';
        document.getElementById('marketOddsPayout').textContent = '';
        document.getElementById('parlayLegs').innerHTML = '';
    }
    
    window.onclick = function(event) {
        if (event.target == popup) {
            popup.style.display = 'none';
            parlayResults.style.display = 'none';
            errorState.classList.add('hidden');
            // Reset all values
            document.getElementById('parlayValueAnalysis').style.display = 'none';
            document.getElementById('parlayGrade').textContent = '';
            document.getElementById('gradeEv').textContent = '';
            document.getElementById('gradeEdge').textContent = '';
            document.getElementById('gradeWinProb').textContent = '';
            document.getElementById('parlayOdds').textContent = '';
            document.getElementById('theoreticalOdds').textContent = '';
            document.getElementById('parlayBetSize').textContent = '';
            document.getElementById('trueOddsPayout').textContent = '';
            document.getElementById('marketOddsPayout').textContent = '';
            document.getElementById('parlayLegs').innerHTML = '';
        }
    }
    
    // Add function to toggle available bets
    window.toggleAvailableBets = function() {
        const betsList = document.getElementById('availableBets');
        const toggle = document.getElementById('availableBetsToggle');
        const betsHeader = document.getElementById('availableBetsHeader');
        
        if (!betsList || !toggle) return;
        
        if (betsList.style.display === 'none') {
            betsList.style.display = 'block';
            toggle.textContent = '▼';
            if (betsHeader) betsHeader.classList.add('active');
        } else {
            betsList.style.display = 'none';
            toggle.textContent = '▶';
            if (betsHeader) betsHeader.classList.remove('active');
        }
    }
    
    // Load bets for a sportsbook
    window.loadParlayBets = async function(sportsbook) {
        currentSportsbook = sportsbook;
        try {
            console.log('Starting to load bets for sportsbook:', sportsbook);
            console.log('Current state of selectedBets:', Array.from(selectedBets));
            console.log('Current state of parlayResults:', parlayResults.style.display);
            console.log('Current state of loadingState:', loadingState.classList.contains('hidden'));
            console.log('Current state of errorState:', errorState.classList.contains('hidden'));
            console.log('Current state of calculateBtn:', calculateBtn.disabled);
            console.log('Current state of availableBets:', document.getElementById('availableBets').innerHTML);
            
            // Show loading state
            popup.style.display = 'block';
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            document.getElementById('availableBets').innerHTML = '';
            selectedBets.clear();
            calculateBtn.disabled = true;
            parlayResults.style.display = 'none';
            
            // Update sportsbook display
            document.getElementById('sportsbook-name').textContent = sportsbook;
            
            // Encode the sportsbook name for URL safety
            const encodedSportsbook = encodeURIComponent(sportsbook);
            
            // Try all possible API endpoints
            const endpoints = [
                `/api/sportsbook/${encodedSportsbook}`,
                `/api/sportsbook_bets/${encodedSportsbook}`,
                `/api/bets?sportsbook=${encodedSportsbook}`
            ];
            
            let successfulEndpoint = null;
            let response = null;
            let data = null;
            
            for (const endpoint of endpoints) {
                try {
                    console.log('Trying API endpoint:', endpoint);
                    response = await fetch(endpoint);
                    
                    if (!response.ok) {
                        console.warn(`Endpoint ${endpoint} returned status ${response.status}`);
                        continue;
                    }
                    
                    data = await response.json();
                    console.log(`Response from ${endpoint}:`, data);
                    successfulEndpoint = endpoint;
                    break;
                } catch (e) {
                    console.error(`Error with endpoint ${endpoint}:`, e);
                }
            }
            
            if (!successfulEndpoint) {
                console.error('All API endpoints failed');
                throw new Error('Could not load bets from any API endpoint. Please try again later.');
            }
            
            console.log('Successfully loaded data from:', successfulEndpoint);
            
            // Debug log
            console.log('Received data from API:', data);
            console.log('Data type:', typeof data);
            console.log('Is array:', Array.isArray(data));
            
            if (typeof data === 'object' && !Array.isArray(data)) {
                console.log('Object keys:', Object.keys(data));
                
                // Check for common response structures
                if (data.bets) console.log('data.bets exists:', typeof data.bets, Array.isArray(data.bets));
                if (data.data) console.log('data.data exists:', typeof data.data, Array.isArray(data.data));
                if (data.results) console.log('data.results exists:', typeof data.results, Array.isArray(data.results));
            }
            
            // Hide loading state
            loadingState.classList.add('hidden');
            
            if (data && data.error) {
                throw new Error(data.error);
            }
            
            // Handle different response formats
            let betsArray = [];
            
            if (Array.isArray(data)) {
                // If data is already an array of bets
                console.log('Data is an array with length:', data.length);
                betsArray = data;
            } else if (data && data.bets && Array.isArray(data.bets)) {
                // If data has a bets property that is an array
                console.log('Data has bets array with length:', data.bets.length);
                betsArray = data.bets;
            } else if (data && data.data && Array.isArray(data.data)) {
                // If data has a data property that is an array
                console.log('Data has data array with length:', data.data.length);
                betsArray = data.data;
            } else if (data && data.results && Array.isArray(data.results)) {
                // If data has a results property that is an array
                console.log('Data has results array with length:', data.results.length);
                betsArray = data.results;
            } else if (typeof data === 'object') {
                // Last resort: check if the object itself contains bet-like objects
                const possibleBets = [];
                for (const key in data) {
                    if (typeof data[key] === 'object' && data[key] !== null) {
                        // Check if this looks like a bet object
                        if (data[key].bet_id || data[key].id || 
                            (data[key].odds !== undefined) || 
                            (data[key].grade !== undefined)) {
                            possibleBets.push(data[key]);
                        }
                    }
                }
                
                if (possibleBets.length > 0) {
                    console.log('Found possible bets by scanning object properties:', possibleBets.length);
                    betsArray = possibleBets;
                } else {
                    console.error('No valid bets array found in response');
                    throw new Error('No eligible bets found for parlay. Response format not recognized.');
                }
            } else {
                // No valid bets found
                console.error('No valid bets array found in response');
                throw new Error('No eligible bets found for parlay. Response format not recognized.');
            }
            
            if (!betsArray.length) {
                console.error('Bets array is empty');
                throw new Error('No eligible bets found for parlay.');
            }
            
            // Add detailed logging of first bet
            if (betsArray.length > 0) {
                console.log('First bet complete data:', betsArray[0]);
                console.log('All bet properties:', Object.keys(betsArray[0]).join(', '));
                // Log all properties and their values
                const firstBet = betsArray[0];
                const allProps = {};
                for (const prop in firstBet) {
                    allProps[prop] = firstBet[prop];
                }
                console.log('All properties and values:', allProps);
            }
            
            // Normalize the bets array to ensure consistent property names
            const normalizedBets = betsArray.map(bet => {
                const normalized = {...bet};
                
                // Ensure bet_id exists
                if (!normalized.bet_id && normalized.id) normalized.bet_id = normalized.id;
                if (!normalized.bet_id) normalized.bet_id = Math.random().toString(36).substring(2, 15);
                
                // Ensure grade exists
                if (!normalized.grade && normalized.rating) normalized.grade = normalized.rating;
                if (!normalized.grade && normalized.grade === undefined) normalized.grade = 'C'; // Default grade
                
                // Ensure odds exists
                if (!normalized.odds && normalized.american_odds !== undefined) normalized.odds = normalized.american_odds;
                if (!normalized.odds && normalized.odds === undefined) normalized.odds = 0;
                
                // Ensure ev_percent exists
                if (!normalized.ev_percent && normalized.ev !== undefined) normalized.ev_percent = normalized.ev;
                if (!normalized.ev_percent && normalized.ev_percent === undefined) normalized.ev_percent = 0;
                
                return normalized;
            });
            
            console.log('Normalized bets:', normalizedBets.length);
            
            // Filter out bets with grade D or F
            const eligibleBets = normalizedBets.filter(bet => {
                const grade = bet.grade;
                console.log(`Bet ${bet.bet_id} grade: ${grade}`);
                return grade !== 'D' && grade !== 'F';
            });
            
            console.log('Eligible bets after filtering:', eligibleBets.length);
            
            if (eligibleBets.length === 0) {
                throw new Error('No eligible bets found for parlay (all bets are grade D or F).');
            }
            
            // Show available bets expanded initially
            document.getElementById('availableBets').style.display = 'block';
            document.getElementById('availableBetsToggle').textContent = '▼';
            
            eligibleBets.forEach(bet => {
                console.log('Processing bet:', {
                    id: bet.bet_id,
                    grade: bet.grade,
                    teams: bet.event_teams || bet.description,
                    ev: bet.ev_percent
                });
                
                const betDiv = document.createElement('div');
                betDiv.className = 'bet-item';
                betDiv.innerHTML = createBetItem(bet);
                
                const checkbox = betDiv.querySelector('input');
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedBets.add(bet.bet_id);
                        betDiv.classList.add('selected');
                    } else {
                        selectedBets.delete(bet.bet_id);
                        betDiv.classList.remove('selected');
                    }
                    calculateBtn.disabled = selectedBets.size < 2;
                    
                    // Clear parlay value analysis when selections change
                    document.getElementById('parlayValueAnalysis').style.display = 'none';
                    document.getElementById('parlayGrade').textContent = '';
                    document.getElementById('gradeEv').textContent = '';
                    document.getElementById('gradeEdge').textContent = '';
                    document.getElementById('gradeWinProb').textContent = '';
                    document.getElementById('parlayOdds').textContent = '';
                    document.getElementById('theoreticalOdds').textContent = '';
                    document.getElementById('parlayBetSize').textContent = '';
                    document.getElementById('trueOddsPayout').textContent = '';
                    document.getElementById('marketOddsPayout').textContent = '';
                    
                    // Update selected bets display
                    const selectedBetsArray = Array.from(document.querySelectorAll('.bet-item.selected')).map(div => {
                        const teams = div.querySelector('.text-gray-900') ? 
                            div.querySelector('.text-gray-900').textContent : 'Unknown';
                        
                        const betTypeEl = div.querySelector('.text-gray-800');
                        const betType = betTypeEl ? betTypeEl.textContent : 'Unknown';
                        
                        const description = '';
                        
                        const oddsEl = div.querySelector('[title="American odds"]');
                        const odds = oddsEl ? oddsEl.textContent.split(': ')[1] : 'N/A';
                        
                        const gradeEl = div.querySelector('.rounded-full');
                        const grade = gradeEl ? gradeEl.textContent.replace('Grade ', '') : 'C';
                        
                        const evEl = div.querySelector('[title="Expected Value"]');
                        const ev = evEl ? evEl.textContent.split(': ')[1] : '0%';
                        
                        return { 
                            event_teams: teams, 
                            bet_type: betType, 
                            description: description, 
                            odds, 
                            grade, 
                            ev_percent: ev.replace('%', '') 
                        };
                    });
                    
                    // Show parlay results section if we have selections
                    if (selectedBetsArray.length > 0) {
                        parlayResults.style.display = 'block';
                        updateParlayLegsDisplay(selectedBetsArray);
                    } else {
                        parlayResults.style.display = 'none';
                    }
                });
                
                document.getElementById('availableBets').appendChild(betDiv);
            });
            
        } catch (error) {
            console.error('Error loading bets:', error);
            loadingState.classList.add('hidden');
            errorState.classList.remove('hidden');
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.textContent = error.message || 'Error loading bets. Please try again.';
            }
        }
    }
    
    // Retry loading bets
    window.retryLoadBets = function() {
        if (currentSportsbook) {
            loadParlayBets(currentSportsbook);
        }
    }
});

function createBetItem(bet) {
    // Helper function to safely format numbers
    const formatNumber = (value, decimals = 2) => {
        if (value === undefined || value === null || isNaN(value)) return 'N/A';
        return Number(value).toFixed(decimals);
    };

    // Helper function to format odds
    const formatOdds = (odds) => {
        if (odds === undefined || odds === null || isNaN(odds)) return 'N/A';
        return odds > 0 ? `+${odds}` : odds.toString();
    };

    // Helper function to calculate hours between two timestamps
    function calculateHoursBetween(eventTime, timestamp) {
        try {
            const eventDate = new Date(eventTime);
            const currentDate = new Date(timestamp);
            const diffInHours = (eventDate - currentDate) / (1000 * 60 * 60);
            return Math.max(0, diffInHours);
        } catch (e) {
            console.error('Error calculating hours between:', e);
            return 0;
        }
    }

    // Helper function to format time
    const formatTime = (timeToEvent, bet) => {
        // If we have event_time and timestamp, calculate the difference
        if (bet && bet.event_time && bet.timestamp) {
            try {
                const hours = calculateHoursBetween(bet.event_time, bet.timestamp);
                return `${formatNumber(hours, 1)}h`;
            } catch (e) {
                console.error('Error formatting time:', e);
                return 'N/A';
            }
        }
        return 'N/A';
    };

    // Format the event display
    let eventDisplay = '';
    
    // Try different combinations of team information
    if (bet.home_team && bet.away_team) {
        eventDisplay = `${bet.home_team} vs ${bet.away_team}`;
    } else if (bet.event_teams) {
        eventDisplay = bet.event_teams;
    } else if (bet.participant) {
        eventDisplay = bet.participant;
    } else if (bet.description && (bet.description.includes('vs') || bet.description.includes('vs.'))) {
        // Try to extract teams from description
        const parts = bet.description.replace('vs.', 'vs').split('vs');
        eventDisplay = `${parts[0].trim()} vs ${parts[1].trim()}`;
    } else if (bet.event_name) {
        eventDisplay = bet.event_name;
    } else if (bet.market_name) {
        eventDisplay = bet.market_name;
    } else {
        eventDisplay = bet.description || 'Unknown Event';
    }

    // Format the bet type display
    let betTypeDisplay = bet.bet_type || bet.market_type || 'Unknown';
    let betDescription = '';
    
    // Add line information if available
    if (bet.line) {
        betTypeDisplay += ` ${bet.line}`;
    } else if (bet.bet_line) {
        betTypeDisplay += ` ${bet.bet_line}`;
    }
    
    // Add selection information if available
    if (bet.selection) {
        betDescription = bet.selection;
    } else if (bet.bet_description) {
        betDescription = bet.bet_description;
    } else if (bet.description && bet.description !== eventDisplay) {
        betDescription = bet.description;
    }

    // Get the time class based on hours until event
    const timeToEvent = formatTime(bet.time_to_event, bet);
    const timeClass = timeToEvent === 'N/A' ? 'text-gray-500' : 'text-blue-600';

    // Format the grade class
    const gradeClass = bet.grade === 'A' ? 'bg-green-100 text-green-800' :
                      bet.grade === 'B' ? 'bg-blue-100 text-blue-800' :
                      bet.grade === 'C' ? 'bg-purple-100 text-purple-800' :
                      'bg-gray-100 text-gray-800';

    // Ensure ev_percent exists
    const evPercent = bet.ev_percent !== undefined ? bet.ev_percent : 
                     (bet.ev !== undefined ? bet.ev : 0);
                     
    // Ensure odds exists
    const odds = bet.odds !== undefined ? bet.odds : 
                (bet.american_odds !== undefined ? bet.american_odds : 0);
                
    // Ensure sport exists
    const sport = bet.sport || bet.category || 'Unknown';
    
    // Ensure league exists
    const league = bet.league || bet.subcategory || '';
    
    console.log(`Creating bet item for: ${eventDisplay}, type: ${betTypeDisplay}, grade: ${bet.grade}`);

    return `
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-start">
                <input type="checkbox" class="mt-1 mr-4" data-bet-id="${bet.bet_id}">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${gradeClass}">
                            Grade ${bet.grade || 'N/A'}
                        </span>
                        <span class="text-xs text-gray-500" title="Expected Value">EV: ${formatNumber(evPercent)}%</span>
                        <span class="text-xs ${timeClass}">Time: ${timeToEvent}</span>
                    </div>
                    ${bet.participant ? `<p class="text-sm font-medium text-gray-900">${bet.participant}</p>` : ''}
                    <p class="text-sm font-medium text-gray-800">${betTypeDisplay}</p>
                    <p class="text-sm font-medium ${bet.participant ? 'text-gray-700' : 'text-gray-900'}">${eventDisplay}</p>
                    ${betDescription ? `<p class="text-sm text-gray-600">${betDescription}</p>` : ''}
                    <p class="text-sm text-gray-500">${sport}${league ? ` - ${league}` : ''}</p>
                    <p class="text-xs text-gray-500" title="American odds">Odds: ${formatOdds(odds)}</p>
                </div>
            </div>
        </div>
    `;
}

function updateParlayLegsDisplay(selectedBets) {
    const parlayLegsContainer = document.getElementById('parlayLegs');
    if (!parlayLegsContainer) return;

    parlayLegsContainer.innerHTML = selectedBets.map((bet, index) => `
        <div class="flex items-start gap-3 p-3 bg-white rounded-lg border border-gray-200">
            <div class="flex-shrink-0 w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-sm font-medium text-gray-600">
                ${index + 1}
            </div>
            <div class="flex-grow">
                <div class="flex items-start justify-between gap-2 mb-2">
                    <div>
                        <div class="text-sm font-medium text-gray-900">${bet.event_teams}</div>
                        <div class="text-xs text-gray-600">${bet.bet_type} - ${bet.description}</div>
                    </div>
                    <div class="flex-shrink-0 text-xs font-medium px-2 py-1 rounded-full ${
                        bet.grade === 'A' ? 'bg-green-200 text-green-900' : 
                        bet.grade === 'B' ? 'bg-blue-200 text-blue-900' : 
                        bet.grade === 'C' ? 'bg-purple-200 text-purple-900' : 
                        bet.grade === 'D' ? 'bg-orange-200 text-orange-900' : 
                        'bg-gray-200 text-gray-900'
                    }">
                        ${bet.grade}
                    </div>
                </div>
                <div class="text-xs text-gray-600">
                    <span class="font-medium">Odds:</span> ${bet.odds}
                    <span class="ml-3 font-medium">EV:</span> ${bet.ev_percent}%
                </div>
            </div>
        </div>
    `).join('');
}
</script> 